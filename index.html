<!DOCTYPE html>
<html lang="en">

<head>
    <title>Cat Meme Pet</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./catpet.css">
</head>

<body id="wallpaper">
    <div id="overlay">
        <img id="fullscreen-gif" />
    </div>
    <div>
        <button class="button" id="toggle-sound">ğŸ”ŠON</button>
        <button class="button" id="toggle-mode">â˜€ï¸Light Mode</button>
    </div>
    <h1 class="text" id="header-text">ğŸ˜¸Your Cat Meme PetğŸ˜¹</h1>
    <div class="text" id="select-text">Select your Cat!</div>
    <div class="row" id="row-submit">
        <select class="select" id="select-type">
            <option value="HappyHappy">Happy Happy</option>
            <option value="Banana">Banana</option>
            <option value="HUH">HUH</option>
            <option value="Uiiaiu">Uiiaiu</option>
        </select>
        <input type="text" class="input" id="input-name" placeholder="cat name (max 12 char)" />
        <button class="button" id="button-name">OK!</button>
    </div>
    <div class="container" id="pet-container"></div>
    <div class="text footer hidden" id="footer">(fun tips: click "interact" 3 times in a row to special effect!)</div>
</body>

<script>
    //====================== CLASS ==============================================
    class Pet {
        constructor(name, options) {
            this.name = name;
            this.photo = options.photo;
            this.gif = options.gif;
            this.sound = options.sound;
            this.type = options.type;

            this.audio = null;
            this.emoteCount = 0;
        }

        resetEmote() {
            this.emoteCount = 0;
        }

        setName(newName) {
            if (!newName.trim()) return;
            this.name = newName
        }

        playSound() {
            if (!this.audio) {
                this.audio = new Audio(this.sound);
            }
            this.audio.muted = !soundEnabled;
            if (this.audio.paused) {
                this.audio.play();
            }
        }

        stopSound() {
            if (this.audio) {
                this.audio.pause();
                this.audio.currentTime = 0;
            }
        }

        muteSound() {
            if (this.audio) {
                this.audio.muted = true;
            }
        }

        unmuteSound() {
            if (this.audio) {
                this.audio.muted = false;
            }
        }

    }
    //============================ SUB-CLASS ========================================================
    class HappyHappy extends Pet {
        constructor(name) {
            super(name, {
                photo: "https://cdn.grapesjs.com/workspaces/cmjcgoehn0by03s506kjaz5hc/assets/d2cff9df-521f-4714-b117-382ee4d1a572__happy-happy-cat.png",
                gif: "https://media.tenor.com/8tgG_KyJqqwAAAAi/happy-happy-happy-happy.gif",
                type: "Happy Happy Cat",
                sound: "https://www.myinstants.com/media/sounds/happy-happy-happy-song.mp3",
            })
        }
        changeImage(img, duration = 8000) {
            // â— bersihkan timeout LAMA milik IMAGE INI
            if (img._timeout) {
                clearTimeout(img._timeout);
                img._timeout = null;
            }

            img.src = this.gif;

            img._timeout = setTimeout(() => {
                img.src = this.photo;
                img._timeout = null;
            }, duration);
        }
        stopImage(img) {
            if (img._timeout) {
                clearTimeout(img._timeout);
                img._timeout = null;
            }
            img.src = this.photo;
        }
    }

    class Banana extends Pet {
        constructor(name) {
            super(name, {
                photo: "https://cdn.grapesjs.com/workspaces/cmjcgoehn0by03s506kjaz5hc/assets/fa0b97d2-6172-4cef-b83a-62ead79646de__banana-cat.png",
                gif: "https://cdn.grapesjs.com/workspaces/cmjcgoehn0by03s506kjaz5hc/assets/263e3b62-d373-4804-bb81-449ade306c3d__banana-cat.gif",
                type: "Banana Cat",
                sound: "https://www.myinstants.com/media/sounds/banana-cat-crying.mp3",
            })
        }
        changeImage(img, duration = 6000) {
            // â— bersihkan timeout LAMA milik IMAGE INI
            if (img._timeout) {
                clearTimeout(img._timeout);
                img._timeout = null;
            }

            img.src = this.gif;

            img._timeout = setTimeout(() => {
                img.src = this.photo;
                img._timeout = null;
            }, duration);
        }
        stopImage(img) {
            if (img._timeout) {
                clearTimeout(img._timeout);
                img._timeout = null;
            }
            img.src = this.photo;
        }
    }

    class HUH extends Pet {
        constructor(name) {
            super(name, {
                photo: "https://cdn.grapesjs.com/workspaces/cmjcgoehn0by03s506kjaz5hc/assets/4f9d628c-03a8-4796-a525-de299a288cb0__huh-cat.png",
                gif: "https://cdn.grapesjs.com/workspaces/cmjcgoehn0by03s506kjaz5hc/assets/15186f1b-8fec-4e66-9a83-3411cd3eebc8__huh-cat.gif",
                type: "HUH? Cat",
                sound: "https://www.myinstants.com/media/sounds/huh-cat-meme.mp3",
            })
        }
        changeImage(img, duration = 4000) {
            // â— bersihkan timeout LAMA milik IMAGE INI
            if (img._timeout) {
                clearTimeout(img._timeout);
                img._timeout = null;
            }

            img.src = this.gif;

            img._timeout = setTimeout(() => {
                img.src = this.photo;
                img._timeout = null;
            }, duration);
        }
        stopImage(img) {
            if (img._timeout) {
                clearTimeout(img._timeout);
                img._timeout = null;
            }
            img.src = this.photo;
        }
    }

    class Uiiaiu extends Pet {
        constructor(name) {
            super(name, {
                photo: "https://cdn.grapesjs.com/workspaces/cmjcgoehn0by03s506kjaz5hc/assets/e6137b27-e17d-40f8-8c22-ee43aa0fb7b8__uiiaiu-cat.png",
                gif: "https://media.tenor.com/sbfBfp3FeY8AAAAi/oia-uia.gif",
                type: "Uiiaiu Cat",
                sound: "https://www.myinstants.com/media/sounds/oiia-oiia-sound.mp3",
            })
        }
        changeImage(img, duration = 6000) {
            // â— bersihkan timeout LAMA milik IMAGE INI
            if (img._timeout) {
                clearTimeout(img._timeout);
                img._timeout = null;
            }

            img.src = this.gif;

            img._timeout = setTimeout(() => {
                img.src = this.photo;
                img._timeout = null;
            }, duration);
        }
        stopImage(img) {
            if (img._timeout) {
                clearTimeout(img._timeout);
                img._timeout = null;
            }
            img.src = this.photo;
        }
    }
    //================ SETTINGAN =================================================================
    const allPets = []
    let soundEnabled = true;
    let lastSoundPet = null;
    let lastEmotedPet = null;
    const footerText = document.getElementById("footer-text");

    function updateFooterText() {
        if (allPets.length > 0) {
            footerText.classList.remove("hidden");
            footerText.classList.add("show");
        } else {
            footerText.classList.add("hidden");
            footerText.classList.remove("show");
        }
    }
    
    function fullscreenEmote(src, duration = 3000) {
        const overlay = document.getElementById("overlay");
        const gif = document.getElementById("fullscreen-gif");

        if (!src) return;

        gif.src = src;
        overlay.classList.add("show");

        setTimeout(() => {
            overlay.classList.remove("show");

            // tunggu animasi fade-out selesai
            setTimeout(() => {
                gif.src = "";
            }, 400); // harus sama dengan transition CSS
        }, duration);
    }

    document.getElementById("toggle-sound").onclick = () => {
        soundEnabled = !soundEnabled;
        document.getElementById("toggle-sound").textContent = soundEnabled ? "ğŸ”ŠON" : "ğŸ”‡OFF";
        localStorage.setItem("soundEnabled", soundEnabled);
        allPets.forEach(pet => {
            if (soundEnabled) {
                pet.unmuteSound();
            } else {
                pet.muteSound();
            }
        });
    };

    const savedSound = localStorage.getItem("soundEnabled");
    if (savedSound !== null) {
        soundEnabled = savedSound === "true";
        document.getElementById("toggle-sound").textContent = soundEnabled ? "ğŸ”ŠON" : "ğŸ”‡OFF";
    }
    if (!soundEnabled) {
        allPets.forEach(pet => pet.muteSound());
    }
    document.getElementById("toggle-mode").onclick = () => {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        document.getElementById("toggle-mode").textContent = isDark ? "ğŸŒ™Dark Mode" : "â˜€ï¸Light Mode";
        localStorage.setItem("darkMode", isDark);
    };

    const savedMode = localStorage.getItem("darkMode");
    if (savedMode === "true") {
        document.body.classList.add("dark");
        document.getElementById("toggle-mode").textContent = "ğŸŒ™Dark Mode";
    }

    //============= RENDER PET CARD ==================================================
    const petContainer = document.getElementById("pet-container");
    const addPetButton = document.getElementById("button-name");

    addPetButton.addEventListener("click", () => {
        const name = document.getElementById("input-name").value;
        const type = document.getElementById("select-type").value;

        if (!name.trim()) return alert("Please enter cat name.");
        if (name.length > 12) return alert(
            "The name contains more that 12 characters. Please choose different name.");

        let pet;
        if (type === "HappyHappy") pet = new HappyHappy(name);
        if (type === "Banana") pet = new Banana(name);
        if (type === "HUH") pet = new HUH(name);
        if (type === "Uiiaiu") pet = new Uiiaiu(name);

        if (!pet) return;
        renderPet(pet);
    });

    function renderPet(pet) {
        allPets.push(pet)
        const card = document.createElement("div");
        card.className = "petCard";

        card.innerHTML = `
            <img src="${pet.photo}" class="petPhoto">
            <div class="row">
                <h2 class="text nama">${pet.name}</h2>
                <button class="button edit">âœï¸</button>
            </div>
            <div class="text" id="text-type">
                <b>${pet.type}</b>
            </div>
            <button class="button emote">Interact</button>
            <button class="button release">Release</button>
        `;
        //============= FUNGSI DALAM PET CARD ===============================
        const nameElement = card.querySelector(".nama");

        card.querySelector(".edit").onclick = () => {
            while (true) {
                newName = prompt("Enter the new name: \n*max 12 characters");
                if (newName === null) return;
                if (newName.trim() === pet.name) {
                    alert("You didn't change the name. Please enter another name.");
                    continue;
                }
                if (!newName.trim()) {
                    alert("You didn't typed anything. Please enter the new name.");
                    continue;
                }
                if (newName.length > 12) {
                    alert("The new name contains more that 12 characters. Please choose different name.")
                    continue;
                }
                break;
            }

            pet.setName(newName);
            nameElement.textContent = pet.name;
            updateFooterText();
            savePets();
        };

        const img = card.querySelector(".petPhoto");
        pet._img = img;

        card.querySelector(".emote").onclick = () => {
            if (lastEmotedPet && lastEmotedPet !== pet) {
                lastEmotedPet.resetEmote();
                if (lastEmotedPet._img) {
                    lastEmotedPet.stopImage(lastEmotedPet._img);
                }
                lastEmotedPet.stopSound();
            }
            lastEmotedPet = pet;
            lastSoundPet = pet;
            pet.emoteCount++;
            pet.changeImage(img);
            pet.playSound();
            if (pet.emoteCount === 3) {
                fullscreenEmote(pet.gif, 3000)
                pet.emoteCount = 0;
            }
        };

        card.querySelector(".release").onclick = () => {
            if (confirm(`U sure u wanna release ${pet.name}? ğŸ¥ºğŸ¥ºğŸ¥º`)) {
                pet.stopSound();
                card.remove();

                const index = allPets.indexOf(pet);
                if (index !== -1) allPets.splice(index, 1);
                updateFooterText();
                savePets();
            }
        };
        savePets();
        petContainer.appendChild(card);
    }

    function savePets() {
        const data = allPets.map(pet => ({
            name: pet.name,
            type: pet.constructor.name // HappyHappy, Banana, dll
        }));
        localStorage.setItem("pets", JSON.stringify(data));
    }

    function loadPets() {
        const saved = localStorage.getItem("pets");
        if (!saved) return;

        const data = JSON.parse(saved);

        data.forEach(item => {
            let pet;
            if (item.type === "HappyHappy") pet = new HappyHappy(item.name);
            if (item.type === "Banana") pet = new Banana(item.name);
            if (item.type === "HUH") pet = new HUH(item.name);
            if (item.type === "Uiiaiu") pet = new Uiiaiu(item.name);

            if (pet) renderPet(pet);
            updateFooterText();
        });
    }
    loadPets();
</script>


</html>
